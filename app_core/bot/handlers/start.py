from aiogram import Router, types
from aiogram.filters import CommandStart, Command
from aiogram.fsm.context import FSMContext
from asgiref.sync import sync_to_async
from app_core.models import User
from ..keyboards.main import get_main_keyboard

router = Router()

@router.message(CommandStart())
@router.message(lambda message: message.text and "–ù–∞–∑–∞–¥" in message.text)
async def on_start(message: types.Message, state: FSMContext):
    tg = message.from_user

    user, created = await sync_to_async(User.objects.get_or_create)(
        telegram_id=str(tg.id),
        defaults={
            "first_name": tg.first_name or "",
        },
    )

    data = await state.get_data()
    is_listener_mode = data.get('is_listener_mode', False)
    user_role = user.role or 'guest'
    await state.update_data(user_role=user_role)

    role_display = "—Å–ø–∏–∫–µ—Ä" if user_role == "speaker" else "–≥–æ—Å—Ç—å"
    if user_role == "speaker" and is_listener_mode:
        role_display = "—Å–ø–∏–∫–µ—Ä (—Ä–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è)"

    help_text = (
        f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!\n"
        f"–†–æ–ª—å: {role_display}\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n\n"
    )

    if user_role == "speaker" and not is_listener_mode:
        help_text += (
            "–†–µ–∂–∏–º —Å–ø–∏–∫–µ—Ä–∞:\n"
            "‚Ä¢ –ù–∞—á–∞—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∂–∏–º –¥–æ–∫–ª–∞–¥–∞ –∏ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã\n"
            "‚Ä¢ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ - –∑–∞–∫–æ–Ω—á–∏—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ\n"
            "‚Ä¢ –ú–æ–∏ –≤–æ–ø—Ä–æ—Å—ã - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∫ –≤–∞—à–∏–º –¥–æ–∫–ª–∞–¥–∞–º\n"
            "‚Ä¢ –†–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è - –ø–µ—Ä–µ–π—Ç–∏ –≤ –æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º\n\n"
        )
    else:
        help_text += (
            "–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
            "‚Ä¢ –ü—Ä–æ–≥—Ä–∞–º–º–∞ - —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–æ–∫–ª–∞–¥–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
            "‚Ä¢ –í–æ–ø—Ä–æ—Å - –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–º—É —Å–ø–∏–∫–µ—Ä—É\n"
            "‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞ - –Ω–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –¥–ª—è –æ–±—â–µ–Ω–∏—è\n"
            "‚Ä¢ –î–æ–Ω–∞—Ç - –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
            "‚Ä¢ –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è - –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö\n"
            "‚Ä¢ –ó–∞—è–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–æ–º - –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ\n"
        )

        if user_role == "speaker":
            help_text += "\n‚Ä¢ –†–µ–∂–∏–º —Å–ø–∏–∫–µ—Ä–∞ - –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º —Å–ø–∏–∫–µ—Ä–∞"

    await message.answer(
        help_text,
        reply_markup=get_main_keyboard(user_role, is_listener_mode)
    )

@router.message(Command("speaker"))
async def switch_to_speaker(message: types.Message, state: FSMContext):
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º —Å–ø–∏–∫–µ—Ä–∞"""
    await state.update_data(user_role='speaker', is_listener_mode=False)
    
    await message.answer(
        "–í—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω—ã –≤ —Ä–µ–∂–∏–º —Å–ø–∏–∫–µ—Ä–∞!\n\n"
        "–¢–µ–ø–µ—Ä—å –≤–∞–º –¥–æ—Å—Ç—É–ø–Ω—ã:\n"
        "‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è–º–∏\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ –∫ –≤–∞—à–∏–º –¥–æ–∫–ª–∞–¥–∞–º\n"
        "‚Ä¢ –†–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —É—á–∞—Å—Ç–∏—è\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        reply_markup=get_main_keyboard('speaker', False)
    )

@router.message(Command("guest"))
async def switch_to_guest(message: types.Message, state: FSMContext):
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º –≥–æ—Å—Ç—è"""
    await state.update_data(user_role='guest', is_listener_mode=False)
    
    await message.answer(
        "–í—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω—ã –≤ —Ä–µ–∂–∏–º –≥–æ—Å—Ç—è!\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:\n"
        "‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã\n"
        "‚Ä¢ –í–æ–ø—Ä–æ—Å—ã —Å–ø–∏–∫–µ—Ä–∞–º\n"
        "‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –¥—Ä—É–≥–∏–º–∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏\n"
        "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
        "‚Ä¢ –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
        reply_markup=get_main_keyboard('guest', False)
    )

@router.message(Command("help"))
async def on_help(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_role = data.get('user_role', 'guest')
    is_listener_mode = data.get('is_listener_mode', False)
    
    if user_role == "speaker" and not is_listener_mode:
        help_text = (
            "–ü–æ–º–æ—â—å –¥–ª—è —Å–ø–∏–∫–µ—Ä–∞:\n\n"
            "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è–º–∏:\n"
            "‚Ä¢ –ù–∞—á–∞—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ - –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–µ–∂–∏–º –¥–æ–∫–ª–∞–¥–∞\n"
            "‚Ä¢ –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ - –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ\n\n"
            "–†–∞–±–æ—Ç–∞ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏:\n"
            "‚Ä¢ –ú–æ–∏ –≤–æ–ø—Ä–æ—Å—ã - –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∫ –≤–∞—à–∏–º –¥–æ–∫–ª–∞–¥–∞–º\n\n"
            "–†–µ–∂–∏–º—ã —É—á–∞—Å—Ç–∏—è:\n"
            "‚Ä¢ –†–µ–∂–∏–º —Å–ª—É—à–∞—Ç–µ–ª—è - —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫\n\n"
            "–¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/speaker - —Å—Ç–∞—Ç—å —Å–ø–∏–∫–µ—Ä–æ–º\n"
            "/guest - —Å—Ç–∞—Ç—å –≥–æ—Å—Ç–µ–º\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
        )
    else:
        help_text = (
            "–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É PythonMeetup:\n\n"
            "üìÖ –ü—Ä–æ–≥—Ä–∞–º–º–∞ - –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–æ–∫–ª–∞–¥–æ–≤ –∏ –≤—Ä–µ–º—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π\n"
            "‚ùì –í–æ–ø—Ä–æ—Å - –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–º—É —Å–ø–∏–∫–µ—Ä—É –≤–æ –≤—Ä–µ–º—è –µ–≥–æ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è\n"
            "üë• –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞ - –Ω–∞–π—Ç–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤ –ø–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –¥–ª—è –æ–±—â–µ–Ω–∏—è\n"  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ
            "üí∞ –î–æ–Ω–∞—Ç - —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–æ–≤ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\n"
            "üîî –ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è - –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—É–¥—É—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö\n"
            "üé§ –ó–∞—è–≤–∫–∞ —Å–ø–∏–∫–µ—Ä–æ–º - –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Å –¥–æ–∫–ª–∞–¥–æ–º\n\n"
            "–¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/speaker - —Å—Ç–∞—Ç—å —Å–ø–∏–∫–µ—Ä–æ–º\n"
            "/guest - —Å—Ç–∞—Ç—å –≥–æ—Å—Ç–µ–º\n"
            "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
        )
    
    await message.answer(help_text)